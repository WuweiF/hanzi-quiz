<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰å­—å°è¾¾äºº - åˆä¸­ç”Ÿè¯†å­—æ£€æµ‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .correct { animation: correct 0.5s ease-in-out; }
        .wrong { animation: wrong 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes correct { 0% { background: #dcfce7; } 50% { background: #86efac; } 100% { background: #dcfce7; } }
        @keyframes wrong { 0% { background: #fee2e2; } 50% { background: #fca5a5; } 100% { background: #fee2e2; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">æ±‰å­—å°è¾¾äºº <span class="text-sm opacity-80">åˆä¸­ç”Ÿè¯†å­—æ£€æµ‹</span></h1>
            <div class="flex items-center gap-4">
                <span id="progress-text">è¿›åº¦ï¼š0/0</span>
                <span id="timer" class="bg-blue-700 px-3 py-1 rounded-full">00:00</span>
            </div>
        </div>
    </nav>

    <!-- ç­”é¢˜åŒºåŸŸ -->
    <main class="container mx-auto p-4 md:p-8 max-w-3xl">
        <!-- ç­”é¢˜å¡ç‰‡ -->
        <div id="question-card" class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8 fade-in hidden">
            <div class="text-center mb-6">
                <span id="current-char" class="text-6xl md:text-8xl font-bold text-gray-800"></span>
                <p class="text-gray-500 mt-2" id="char-hint">ç‚¹å‡»é€‰é¡¹é€‰æ‹©æ­£ç¡®è¯»éŸ³</p>
            </div>

            <!-- é€‰é¡¹åŒºåŸŸï¼ˆæ‹¼éŸ³é€‰æ‹©é¢˜ï¼‰ -->
            <div id="options-container" class="grid grid-cols-2 gap-4 mb-6">
                <!-- é€‰é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- åé¦ˆåŒºåŸŸ -->
            <div id="feedback" class="hidden text-center py-2 rounded-lg mb-4"></div>

            <!-- ä¸‹ä¸€é¢˜æŒ‰é’® -->
            <button id="next-btn" class="hidden w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                ä¸‹ä¸€é¢˜ <i class="fa fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- å¼€å§‹ç­”é¢˜æŒ‰é’® -->
        <div id="start-section" class="text-center py-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">æ¬¢è¿å‚ä¸æ±‰å­—è¯†å­—æ£€æµ‹</h2>
            <p class="text-gray-600 mb-8">æœ¬æ¬¡æ£€æµ‹å°†éšæœºæŠ½å–20ä¸ªæ±‰å­—ï¼Œæ£€éªŒä½ çš„è¯†å­—æ°´å¹³ï¼Œå¼€å§‹æŒ‘æˆ˜å§ï¼</p>
            <button id="start-btn" class="bg-green-600 text-white px-8 py-4 rounded-lg text-xl hover:bg-green-700 transition-colors shadow-md">
                <i class="fa fa-play-circle mr-2"></i> å¼€å§‹ç­”é¢˜
            </button>
        </div>

        <!-- ç­”é¢˜ç»“æœé¡µ -->
        <div id="result-section" class="hidden bg-white rounded-xl shadow-lg p-6 md:p-8">
            <h2 class="text-2xl font-bold text-center mb-6">ç­”é¢˜å®Œæˆï¼</h2>
            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <p class="text-gray-600 mb-1">æ€»é¢˜æ•°</p>
                    <p class="text-3xl font-bold text-blue-600" id="total-count">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <p class="text-gray-600 mb-1">æ­£ç¡®æ•°</p>
                    <p class="text-3xl font-bold text-green-600" id="correct-count">0</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <p class="text-gray-600 mb-1">æ­£ç¡®ç‡</p>
                    <p class="text-3xl font-bold text-yellow-600" id="accuracy-rate">0%</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <p class="text-gray-600 mb-1">è¯†å­—ç­‰çº§</p>
                    <p class="text-3xl font-bold text-purple-600" id="level">--</p>
                </div>
            </div>

            <!-- é”™è¯¯å­—åˆ—è¡¨ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">éœ€åŠ å¼ºçš„æ±‰å­—ï¼š</h3>
                <div id="wrong-chars" class="flex flex-wrap gap-3">
                    <!-- é”™è¯¯å­—å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- é‡æ–°ç­”é¢˜æŒ‰é’® -->
            <button id="restart-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fa fa-refresh mr-2"></i> é‡æ–°ç­”é¢˜
            </button>
        </div>
    </main>

    <script>
        
        let charDatabase = [];
        // æ–°å¢ï¼šä»åç«¯è·å–å­—åº“
        async function fetchCharDatabase() {
            try {
                const response = await fetch('https://hanzi-quiz-server.onrender.com/api/char-database'); // åç»­æ›¿æ¢ä¸ºå®é™…åŸŸå
                charDatabase = await response.json();
                console.log('å­—åº“åŠ è½½æˆåŠŸï¼š', charDatabase);
            } catch (error) {
                console.error('å­—åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ç”¨æ•°æ®ï¼š', error);
                // å¤‡ç”¨æœ¬åœ°æ•°æ®ï¼ˆé˜²æ­¢åç«¯æ•…éšœï¼‰
                charDatabase = [
                    { "id": 1, "char": "äº˜", "pinyin": "gÃ¨n", "wrongOptions": ["yuÃ¡n", "hÃ©ng", "gÃ¨ng"], "explanation": "ç©ºé—´å’Œæ—¶é—´ä¸Šå»¶ç»­ä¸æ–­" },
                    // ... ä¿ç•™åŸæœ‰æœ¬åœ°æ•°æ®
                ];
            }
        }
        
        // ä¿®æ”¹initå‡½æ•°ï¼Œå…ˆåŠ è½½å­—åº“
        function init() {
            fetchCharDatabase(); // æ–°å¢
            startBtn.addEventListener('click', startQuiz);
            restartBtn.addEventListener('click', restartQuiz);
            nextBtn.addEventListener('click', showNextQuestion);
        }
        
        // ä¿®æ”¹collectDataå‡½æ•°ï¼Œå¯¹æ¥åç«¯æ¥å£
        function collectData(charId, isCorrect) {
            // å‘é€æ•°æ®åˆ°åç«¯
            fetch('https://ä½ çš„åç«¯åŸŸå/api/record-answer', { // åç»­æ›¿æ¢ä¸ºå®é™…åŸŸå
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    charId: charId,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString(),
                    duration: Math.floor((Date.now() - startTime) / 1000)
                })
            })
            .then(res => res.json())
            .then(data => console.log('æ•°æ®æäº¤æˆåŠŸï¼š', data))
            .catch(error => console.error('æ•°æ®æäº¤å¤±è´¥ï¼š', error));
        }

        // å…¨å±€å˜é‡
        let currentQuestions = []; // æœ¬æ¬¡ç­”é¢˜çš„é¢˜ç›®åˆ—è¡¨
        let currentIndex = 0;      // å½“å‰ç­”é¢˜ç´¢å¼•
        let correctCount = 0;      // æ­£ç¡®æ•°
        let wrongChars = [];       // é”™è¯¯å­—åˆ—è¡¨
        let timer = null;          // è®¡æ—¶å®šæ—¶å™¨
        let startTime = 0;         // å¼€å§‹æ—¶é—´

        // DOMå…ƒç´ 
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const startSection = document.getElementById('start-section');
        const questionCard = document.getElementById('question-card');
        const resultSection = document.getElementById('result-section');
        const currentChar = document.getElementById('current-char');
        const optionsContainer = document.getElementById('options-container');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');
        const progressText = document.getElementById('progress-text');
        const timerEl = document.getElementById('timer');

        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // ç»‘å®šäº‹ä»¶
            startBtn.addEventListener('click', startQuiz);
            restartBtn.addEventListener('click', restartQuiz);
            nextBtn.addEventListener('click', showNextQuestion);
        }

        // å¼€å§‹ç­”é¢˜
        function startQuiz() {
            // éšæœºæŠ½å–20ä¸ªé¢˜ç›®ï¼ˆå¯é…ç½®æ•°é‡ï¼‰
            currentQuestions = [...charDatabase].sort(() => 0.5 - Math.random()).slice(0, 20);
            currentIndex = 0;
            correctCount = 0;
            wrongChars = [];

            // éšè—å¼€å§‹åŒºåŸŸï¼Œæ˜¾ç¤ºç­”é¢˜å¡ç‰‡
            startSection.classList.add('hidden');
            questionCard.classList.remove('hidden');

            // å¼€å§‹è®¡æ—¶
            startTime = Date.now();
            startTimer();

            // æ˜¾ç¤ºç¬¬ä¸€é¢˜
            showCurrentQuestion();
            updateProgress();
        }

        // é‡æ–°ç­”é¢˜
        function restartQuiz() {
            resultSection.classList.add('hidden');
            startSection.classList.remove('hidden');
            clearInterval(timer);
            timerEl.textContent = "00:00";
        }

        // æ˜¾ç¤ºå½“å‰é¢˜ç›®
        function showCurrentQuestion() {
            // é‡ç½®åé¦ˆå’Œä¸‹ä¸€é¢˜æŒ‰é’®
            feedback.classList.add('hidden');
            nextBtn.classList.add('hidden');
            optionsContainer.innerHTML = '';
            feedback.className = 'hidden text-center py-2 rounded-lg mb-4';

            const question = currentQuestions[currentIndex];
            currentChar.textContent = question.char;

            // ç”Ÿæˆé€‰é¡¹ï¼ˆæ­£ç¡®é€‰é¡¹+é”™è¯¯é€‰é¡¹ï¼Œéšæœºæ’åºï¼‰
            const allOptions = [...question.wrongOptions, question.pinyin].sort(() => 0.5 - Math.random());
            allOptions.forEach(option => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'border border-gray-300 rounded-lg py-3 px-4 hover:bg-gray-50 transition-colors text-lg';
                optionBtn.textContent = option;
                optionBtn.addEventListener('click', () => checkAnswer(option, question.pinyin));
                optionsContainer.appendChild(optionBtn);
            });
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(selectedOption, correctOption) {
            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
            const options = optionsContainer.querySelectorAll('button');
            options.forEach(btn => {
                btn.disabled = true;
                // æ ‡è®°æ­£ç¡®/é”™è¯¯é€‰é¡¹
                if (btn.textContent === correctOption) {
                    btn.classList.remove('border-gray-300');
                    btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
                } else if (btn.textContent === selectedOption) {
                    btn.classList.remove('border-gray-300');
                    btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                }
            });

            // æ˜¾ç¤ºåé¦ˆ
            feedback.classList.remove('hidden');
            if (selectedOption === correctOption) {
                // æ­£ç¡®åé¦ˆ
                feedback.textContent = 'æ­£ç¡®ï¼ğŸ‰ ' + currentQuestions[currentIndex].explanation;
                feedback.classList.add('bg-green-100', 'text-green-800', 'correct');
                correctCount++;
            } else {
                // é”™è¯¯åé¦ˆ
                feedback.textContent = `é”™è¯¯ ğŸ˜“ æ­£ç¡®è¯»éŸ³æ˜¯ï¼š${correctOption}ï¼Œ${currentQuestions[currentIndex].explanation}`;
                feedback.classList.add('bg-red-100', 'text-red-800', 'wrong');
                wrongChars.push(currentQuestions[currentIndex].char);
            }

            // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
            nextBtn.classList.remove('hidden');

            // æ”¶é›†ç­”é¢˜æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­å‘é€åˆ°åç«¯ï¼‰
            collectData(currentQuestions[currentIndex].id, selectedOption === correctOption);
        }

        // æ˜¾ç¤ºä¸‹ä¸€é¢˜
        function showNextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                // æœ‰ä¸‹ä¸€é¢˜
                showCurrentQuestion();
                updateProgress();
            } else {
                // ç­”é¢˜å®Œæˆ
                finishQuiz();
            }
        }

        // å®Œæˆç­”é¢˜
        function finishQuiz() {
            // åœæ­¢è®¡æ—¶
            clearInterval(timer);

            // éšè—ç­”é¢˜å¡ç‰‡ï¼Œæ˜¾ç¤ºç»“æœ
            questionCard.classList.add('hidden');
            resultSection.classList.remove('hidden');

            // è®¡ç®—ç»“æœ
            const totalCount = currentQuestions.length;
            const accuracy = ((correctCount / totalCount) * 100).toFixed(1);
            let level = '';
            if (accuracy >= 90) level = 'ç²¾é€š';
            else if (accuracy >= 70) level = 'è¿›é˜¶';
            else if (accuracy >= 50) level = 'å…¥é—¨';
            else level = 'éœ€æå‡';

            // æ›´æ–°ç»“æœé¡µé¢
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
            document.getElementById('level').textContent = level;

            // æ˜¾ç¤ºé”™è¯¯å­—
            const wrongCharsEl = document.getElementById('wrong-chars');
            wrongCharsEl.innerHTML = '';
            if (wrongChars.length === 0) {
                wrongCharsEl.innerHTML = '<p class="text-gray-500">å…¨éƒ¨æ­£ç¡®ï¼Œå¤ªæ£’äº†ï¼</p>';
            } else {
                wrongChars.forEach(char => {
                    const charTag = document.createElement('span');
                    charTag.className = 'bg-red-100 text-red-800 px-3 py-1 rounded-full';
                    charTag.textContent = char;
                    wrongCharsEl.appendChild(charTag);
                });
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            progressText.textContent = `è¿›åº¦ï¼š${currentIndex + 1}/${currentQuestions.length}`;
        }

        // å¯åŠ¨è®¡æ—¶å™¨
        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                timerEl.textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // æ”¶é›†ç­”é¢˜æ•°æ®ï¼ˆæ¨¡æ‹Ÿå‘é€åˆ°åç«¯ï¼‰
        function collectData(charId, isCorrect) {
            // å®é™…é¡¹ç›®ä¸­ä½¿ç”¨fetchå‘é€POSTè¯·æ±‚
            console.log('æ”¶é›†æ•°æ®ï¼š', {
                charId: charId,
                isCorrect: isCorrect,
                timestamp: new Date().toISOString(),
                duration: Math.floor((Date.now() - startTime) / 1000)
            });

            // ç¤ºä¾‹ï¼š
            // fetch('/api/record-answer', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({
            //         studentId: localStorage.getItem('studentId'), // å®é™…éœ€å­¦ç”ŸID
            //         charId: charId,
            //         isCorrect: isCorrect,
            //         timestamp: new Date().toISOString()
            //     })
            // });
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
